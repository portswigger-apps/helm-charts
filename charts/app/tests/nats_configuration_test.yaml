suite: NATS Configuration

templates:
  - kubernetes/deployment.yaml
  - cilium/networkpolicy.yaml

tests:
  - it: should not enable NATS by default
    template: kubernetes/deployment.yaml
    asserts:
      - notContains:
          path: spec.template.spec.containers[?(@.name == "RELEASE-NAME")].env
          content:
            name: NATS_URL
      - notContains:
          path: spec.template.spec.containers[?(@.name == "RELEASE-NAME")].env
          content:
            name: NATS_TOKEN_FILE

  - it: should not add NATS volume when disabled
    template: kubernetes/deployment.yaml
    asserts:
      - notContains:
          path: spec.template.spec.volumes
          content:
            name: nats-token

  - it: should add NATS projected service account token volume when enabled
    template: kubernetes/deployment.yaml
    set:
      infra:
        nats:
          enabled: true
    asserts:
      - contains:
          path: spec.template.spec.volumes
          content:
            name: nats-token
            projected:
              sources:
                - serviceAccountToken:
                    audience: nats
                    expirationSeconds: 3600
                    path: token

  - it: should add NATS volume mount when enabled
    template: kubernetes/deployment.yaml
    set:
      infra:
        nats:
          enabled: true
    asserts:
      - contains:
          path: spec.template.spec.containers[?(@.name == "RELEASE-NAME")].volumeMounts
          content:
            mountPath: /var/run/secrets/nats
            name: nats-token
            readOnly: true

  - it: should use custom token expiration when configured
    template: kubernetes/deployment.yaml
    set:
      infra:
        nats:
          enabled: true
          tokenExpirationSeconds: 7200
    asserts:
      - contains:
          path: spec.template.spec.volumes
          content:
            name: nats-token
            projected:
              sources:
                - serviceAccountToken:
                    audience: nats
                    expirationSeconds: 7200
                    path: token
