suite: ServiceAccount

templates:
  - kubernetes/serviceaccount.yaml

tests:
  - it: should create a ServiceAccount by default
    asserts:
      - hasDocuments:
        count: 1
      - isKind:
          of: ServiceAccount
      - equal:
          path: metadata.name
          value: RELEASE-NAME
      - equal:
          path: automountServiceAccountToken
          value: false

  - it: should create a ServiceAccount if enabled is false
    set:
      global:
        serviceAccount:
          enabled: false
    asserts:
      - hasDocuments:
          count: 0

  - it: should add irsa role annotation
    set:
      global:
        aws:
          accountId: "account-id"
    asserts:
      - equal:
          path: metadata.annotations
          value:
            eks.amazonaws.com/role-arn: arn:aws:iam::account-id:role/product-roles/RELEASE-NAME-irsarole
