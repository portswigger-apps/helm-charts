suite: Middleware (cfauth)

templates:
  - traefik/cloudfront-header-auth-middleware.yaml

tests:
  - it: should not create CloudFront header auth middleware by default
    asserts:
      - hasDocuments:
          count: 0

  - it: should create CloudFront header auth middleware by default when cloudfront is enabled
    set:
      infra:
        cloudfront:
          enabled: true
      global:
        ingress:
          host: docs-site.platform-dev.portswigger.io
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: Middleware
      - equal:
          path: spec.plugin.bouncer.headers[0]
          value:
            header:
            name: X-Cloudfront-Auth
            values:
              - 12c772c0c15bc525bd439a1774f21db7e1db1126788001af4818b219483f8f18
            matchtype: one

  - it: should not create CloudFront header auth middleware cloudfront is enabled but headerAuth is not enabled
    set:
      infra:
        cloudfront:
          enabled: true
          originHeaderAuth: true
      global:
        ingress:
          host: docs-site.platform-dev.portswigger.io
    asserts:
      - hasDocuments:
          count: 1
