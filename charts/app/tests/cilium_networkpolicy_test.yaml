suite: CiliumNetworkPolicy

templates:
  - cilium/networkpolicy.yaml

tests:
  - it: should create a CiliumNetworkPolicy by default
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: CiliumNetworkPolicy

  - it: should allow egress to kube-dns ONLY by default
    asserts:
      - equal:
          path: spec.egress
          value:
            - toEndpoints:
                - matchLabels:
                    k8s-app: kube-dns
                    k8s:io.kubernetes.pod.namespace: kube-system
              toPorts:
                - ports:
                    - port: "53"
                      protocol: ANY
                  rules:
                    dns:
                      - matchPattern: "*"

  - it: should allow ingress from self by default
    asserts:
      - contains:
          path: spec.ingress
          content:
            fromEndpoints:
              - matchLabels:
                  app.kubernetes.io/app: RELEASE-NAME
                  app.kubernetes.io/instance: app-RELEASE-NAME
                  k8s:io.kubernetes.pod.namespace: NAMESPACE
            toPorts:
              - ports:
                  - port: "8080"
                    protocol: TCP

  - it: should allow ingress from the observability agent by default
    asserts:
      - contains:
          path: spec.ingress
          content:
            fromEndpoints:
              - matchLabels:
                  k8s:io.kubernetes.pod.namespace: observability
                  app.kubernetes.io/name: grafana-agent
            toPorts:
              - ports:
                  - port: "8080"
                    protocol: TCP

  - it: should allow ingress from the observability agent to configured metrics ports
    set:
      ports:
        metrics-port:
          port: 8081
          protocol: TCP
      metricsEndpoint:
        path: /metrics
        port: metrics-port
    asserts:
      - contains:
          path: spec.ingress
          content:
            fromEndpoints:
              - matchLabels:
                  k8s:io.kubernetes.pod.namespace: observability
                  app.kubernetes.io/name: grafana-agent
            toPorts:
              - ports:
                  - port: "8081"
                    protocol: TCP

  - it: should allow access from ingress controller if configured
    set:
      global:
        ingress:
          enabled: true
    asserts:
      - contains:
          path: spec.ingress
          content:
            fromEndpoints:
              - matchLabels:
                  app.kubernetes.io/name: traefik
                  k8s:io.kubernetes.pod.namespace: ingress
            toPorts:
              - ports:
                  - port: "8080"
                    protocol: TCP

  - it: should add custom ingress rules
    set:
      ciliumNetworkPolicy:
        ingress:
          - fromEndpoints:
              - matchLabels:
                  app.kubernetes.io/name: frontend
                  k8s:io.kubernetes.pod.namespace: NAMESPACE
            toPorts:
              - ports:
                  - port: "8080"
                    protocol: TCP
    asserts:
      - contains:
          path: spec.ingress
          content:
            fromEndpoints:
              - matchLabels:
                  app.kubernetes.io/name: frontend
                  k8s:io.kubernetes.pod.namespace: NAMESPACE
            toPorts:
              - ports:
                  - port: "8080"
                    protocol: TCP

  - it: should add custom egress rules
    set:
      ciliumNetworkPolicy:
        egress:
          - toFQDNs:
              - matchName: "my-remote-service.com"
            toPorts:
              - ports:
                  - port: "443"
                    protocol: TCP
    asserts:
      - contains:
          path: spec.egress
          content:
            toFQDNs:
              - matchName: "my-remote-service.com"
            toPorts:
              - ports:
                  - port: "443"
                    protocol: TCP
