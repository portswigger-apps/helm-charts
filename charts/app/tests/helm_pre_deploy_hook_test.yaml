suite: PreDeployHook

templates:
  - helm/pre-deploy-hook.yaml

tests:
  - it: should not create a PreDeployHook by default
    asserts:
      - hasDocuments:
          count: 0

  - it: should create a PreDeployHook with a given command
    set:
      preDeployCommand: ["python3", "manage.py", "migrate"]
    asserts:
      - hasDocuments:
          count: 1
      - equal:
          path: spec.template.spec.containers[0].command
          value:
            - python3
            - manage.py
            - migrate

  - it: should create a PreDeployHook with database environment variables
    set:
      preDeployCommand: ["python3"]
      infra:
        postgres:
          enabled: true
    asserts:
      - hasDocuments:
          count: 1
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: "DATABASE_NAME"
            value: app
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: "DATABASE_HOST"
            valueFrom:
              secretKeyRef:
                key: host
                name: RELEASE-NAME-postgres
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: "DATABASE_PORT"
            valueFrom:
              secretKeyRef:
                key: port
                name: RELEASE-NAME-postgres
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: "DATABASE_USERNAME"
            valueFrom:
              secretKeyRef:
                key: username
                name: RELEASE-NAME-postgres
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: "DATABASE_PASSWORD"
            valueFrom:
              secretKeyRef:
                key: password
                name: RELEASE-NAME-postgres
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: DATABASE_URL
            value: postgres://$(DATABASE_USERNAME):$(DATABASE_PASSWORD)@$(DATABASE_HOST):$(DATABASE_PORT)/$(DATABASE_NAME)
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: JDBC_DATABASE_URL
            value: jdbc:postgresql://$(DATABASE_HOST):$(DATABASE_PORT)/$(DATABASE_NAME)?user=$(DATABASE_USERNAME)&password=$(DATABASE_PASSWORD)

  - it: should create a PreDeployHook with database environment variables when a postgres nameOverride is set
    set:
      preDeployCommand: ["python3"]
      infra:
        postgres:
          enabled: true
          create: false
          nameOverride: database-name
    asserts:
      - hasDocuments:
          count: 1
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: "DATABASE_HOST"
            valueFrom:
              secretKeyRef:
                key: host
                name: database-name-postgres

  - it: should create a PreDeployHook with s3Bucket environment variables
    set:
      infra:
        s3Bucket:
          enabled: true
      preDeployCommand: ["python3"]
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: S3_BUCKET_NAME
            valueFrom:
              secretKeyRef:
                name: RELEASE-NAME-s3bucket
                key: id
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: "S3_BUCKET_URL"
            value: s3://$(S3_BUCKET_NAME)/
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: "S3_ENDPOINT_URL"
            value: "https://s3.$(AWS_REGION).amazonaws.com/"

  - it: should create a PreDeployHook with s3Bucket environment variables if nameOverride set
    set:
      infra:
        s3Bucket:
          enabled: true
          create: false
          nameOverride: cool-bucket
      preDeployCommand: ["python3"]
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: S3_BUCKET_NAME
            valueFrom:
              secretKeyRef:
                name: cool-bucket-s3bucket
                key: id
