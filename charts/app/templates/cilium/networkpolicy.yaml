{{- if .Values.ciliumNetworkPolicy.enabled -}}
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: {{ include "app.name" . }}
spec:
  endpointSelector:
    matchLabels:
      {{- include "app.labelselector" . | nindent 6 }}

  ingress:
  - fromEndpoints:
    - matchLabels:
        k8s:io.kubernetes.pod.namespace: {{ .Release.Namespace }}
        {{- include "app.labelselector" . | nindent 8 }}
    {{- range .Values.ciliumNetworkPolicy.fromApps }}
    - matchLabels:
        k8s:io.kubernetes.pod.namespace: {{ default $.Release.Namespace .namespace }}
        app.kubernetes.io/app: {{ .name }}
    {{- end }}
    {{- if .Values.global.ingress.enabled }}
    - matchLabels: {{ toYaml .Values.ciliumNetworkPolicy.ingressControllerEndpointMatchLabels | nindent 8 }}
    {{- end }}
    toPorts:
    - ports:
      - protocol: {{ (get .Values.ports "app-port").protocol }}
        port: {{ (get .Values.ports "app-port").port | quote }}

  - fromEndpoints:
    - matchLabels: {{ toYaml .Values.ciliumNetworkPolicy.observabilityAgentEndpointMatchLabels | nindent 8 }}
    toPorts:
    - ports:
      {{- $portName := .Values.metricsEndpoint.port }}
      {{- $portSpec := get .Values.ports $portName }}
      - protocol: {{ $portSpec.protocol }}
        port: {{ $portSpec.port | quote }}

  {{- range .Values.ciliumNetworkPolicy.ingress }}
  - {{ toYaml . | nindent 4 | trim }}
  {{- end }}

  egress:
  - toEndpoints:
    - matchLabels:
        k8s:io.kubernetes.pod.namespace: kube-system
        k8s-app: kube-dns
    toPorts:
    - ports:
      - port: "53"
        protocol: ANY
      rules:
        dns:
        - matchPattern: "*"

  {{- with .Values.ciliumNetworkPolicy.toApps }}
  - toEndpoints:
    {{- range . }}
    - matchLabels:
        k8s:io.kubernetes.pod.namespace: {{ default $.Release.Namespace .namespace }}
        app.kubernetes.io/app: {{ .name }}
    {{- end }}
  {{- end }}

  {{- if .Values.infra.s3Bucket.enabled }}
  - toFQDNs:
    - matchPattern: "*.s3.*.amazonaws.com"
    - matchPattern: "sts.amazonaws.com"
    - matchPattern: "*.s3.amazonaws.com"
    toPorts:
    - ports:
      - port: "443"
        protocol: TCP
  {{- end }}

  {{- if .Values.infra.redis.enabled }}
  - toFQDNs:
      - matchPattern: "*.*.*.*.cache.amazonaws.com"
    toPorts:
      - ports:
          - port: "6379"
            protocol: TCP
  {{- end }}

  {{- if .Values.infra.postgres.enabled }}
  - toFQDNs:
    - matchPattern: {{ default .Release.Name .Values.infra.postgres.nameOverride }}.*.*.rds.amazonaws.com
    toPorts:
    - ports:
      - port: "5432"
        protocol: TCP
  {{- end }}

  {{- with .Values.ciliumNetworkPolicy.externalHttpsServices }}
  - toFQDNs:
    {{- range . }}
    - matchName: {{ . }}
    {{- end }}
    toPorts:
    - ports:
      - port: "443"
        protocol: TCP
  {{- end }}

  {{- range .Values.ciliumNetworkPolicy.egress }}
  - {{ toYaml . | nindent 4 | trim }}
  {{- end }}
{{- end }}
